<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>CSGO Item Price</title>
	<script src="https://cdn.staticfile.org/vue/3.2.33/vue.global.prod.js"></script>
	<link href="https://unpkg.com/daisyui@2.15.2/dist/full.css" rel="stylesheet" type="text/css" />
	<link href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" type="text/css" />
</head>

<body>
	<script>
		var init = async function () {
			// var schema = await fetch('/api/?mod=schema').then(res => res.json());
			// var price = await fetch('/api/?mod=price').then(res => res.json());
			var schema = await fetch('/api/schema').then(res => res.json());
			var price = await fetch('/api/price').then(res => res.json());
			var items = {};
			schema.result.items.forEach(item => {
				items[item.defindex] = item;
			});
			var qualities = {};
			for (let quality in schema.result.qualities) {
				qualities[schema.result.qualities[quality]] = schema.result.qualityNames[quality];
			}
			var data = [];
			price.result.assets.forEach(asset => {
				var tdata = {};
				tdata['defindex'] = asset.name;
				tdata['date'] = asset.date;
				tdata['prices'] = {};
				for (let currency in asset.prices) {
					if (asset.prices[currency] != 0) {
						tdata['prices'][currency] = asset.prices[currency];
					}
				}
				tdata['classid'] = asset.classid;
				tdata['image'] = items[asset.name].image_url.replace('"steamcdn-a.akamaihd.net',
					'media.st.dl.pinyuncloud.com');
				tdata['name'] = items[asset.name].item_name;
				tdata['quality'] = qualities[items[asset.name].item_quality];
				data.push(tdata);
			});
			delete schema, price, items, qualities;
			var app = Vue.createApp({
				data() {
					return {
						data: data
					}
				},
				methods: {
					updateModal(item) {
						var modal = Vue.createApp({
							data() {
								return {
									item: item
								}
							}
						});
						modal.mount('#modal');
						delete modal;
					}
				}
			});
			app.mount('#main_area');
			document.querySelector('#load').style.display = 'none';
			delete app;
		};
		init();
	</script>
	<div class="sticky navbar bg-base-100 bg-primary w-full top-0 z-30 bg-opacity-70 backdrop-blur"
		style="margin: 0 auto;">
		<a class="btn btn-ghost normal-case text-xl">CSGO Item Price</a>
	</div>
	<div id="main_area" class="flex">
		<div class="overflow-x-auto w-full" style="margin: 0 auto;">
			<table class="table table-compact w-full">
				<thead>
					<tr>
						<th style="position: initial;">名称</th>
						<th>价格</th>
						<th>ClassID</th>
						<th>日期</th>
						<th>操作</th>
					</tr>
				</thead>
				<tbody>
					<tr v-for="item in data">
						<td>
							<div class="flex items-center space-x-3">
								<div class="avatar">
									<div class="mask mask-squircle w-12 h-12">
										<img :src="`${item.image}`" alt="" />
									</div>
								</div>
								<div>
									<div class="font-bold">{{ item.name }}</div>
									<div class="text-sm opacity-50">{{ item.quality }}</div>
								</div>
							</div>
						</td>
						<td>
							￥ {{ (item.prices.CNY / 100).toFixed(2) }}
						</td>
						<td>
							{{ item.classid }}
							<br>
							<span class="badge badge-ghost badge-sm">defindex: {{ item.defindex }}</span>
						</td>
						<td>{{ item.date }}</td>
						<th>
							<label for="modal-detail" @click="updateModal(item)"
								class="btn btn-primary btn-xs">查看详情</label>
						</th>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
	<input type="checkbox" id="modal-detail" class="modal-toggle" />
	<label id="modal" for="modal-detail" class="modal cursor-pointer">
		<label class="modal-box relative" for="">
			<h3 class="font-bold text-lg">{{ item.name }}</h3>
			<img :src="`${item.image}`" style="width: 68px;" />
			<p class="py-4">ClassID: {{ item.classid }}<br>
				DefIndex: {{ item.defindex }}<br>
				日期: {{ item.date }}<br>
				品质: {{ item.quality }}</p>
			<table class="table table-compact w-full">
				<thead>
					<tr>
						<th>区域</th>
						<th>价格</th>
					</tr>
				</thead>
				<tbody>
					<tr v-for="(price, currency) in item.prices">
						<td>
							{{ currency }}
						</td>
						<td>
							{{ (price / 100).toFixed(2) }}
						</td>
					</tr>
				</tbody>
			</table>
		</label>
	</label>
	<div id="load" class="hero min-h-screen bg-base-200" style="position: absolute; top: 0; left: 0; z-index: 9999;">
		<div class="hero-content text-center">
			<div class="max-w-md">
				<h1 class="text-5xl font-bold">加载中……</h1>
			</div>
		</div>
	</div>
</body>

</html>